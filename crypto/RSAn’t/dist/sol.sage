from sage.all import *
from Crypto.Util.number import *

e = 65537

ciphertext = 179299686848994539141122382962230037744384497621603198124077003991636319769603564062817092353600906591207476251327282277695110268704615120068654776183507204512702766847930125900500659983050185274344899025779726523565280032908194763356944549824963215339419038543390439655210741510143003582737996617770895692162306286064421718892797213765237300926925675153074894532935937291295802157305724856321584517131226940140190491157709894421683196766707672593154406263054436900566231464719102312973247466510418770039194000878897515838985623461176782628261365771619698859295767451162504151010728056594695117040661023327968023451519804564

c1 = 123377882241082251325350065419048806024607608617091688983830323277604694641240653374439302807138122463323990418348747537591347656262195555533468416119550902963546537686539626424151682647446653286178409257716563958279306978514921053134482777035689209563599648603507287706662378931300585730154813000147325737518201568052630101704051194396183990174893718130243703251255733422231215114594356086085529845721945162634747194330158630722370297888040809287372214916411109961066039419282486341414973486625115394106601990911459069075609672097833893961312251252396858703096951885954537748265354572684903035976149443662164781331591137509

c2 = 216996462348882812127549126696128848915007479735759067925583940914005783704777739383583486500248026532990006813147882357469539758674416271697210195684094572116588619081813131930186778045755089586040232978039441432232050042271853194470413044599117641325812011411950889172242559099135026172425733801215110286748370156962444409678069139574351948837982999861835569715249682828276876910129256029485173183675521926552841364713489224945222100475996799601024631599522598983661501357640196487134275394097207489818217501235732511301942649024362999538093008833593968191799917057618382726046836320499881842515455356124359654138411130319

# Recover N
m1 = bytes_to_long(b'factoring modulus?')
m2 = bytes_to_long(b'without the modulus?')

N = gcd(pow(m1, e) - int(c1), pow(m2, e) - int(c2))
print(f'Recovered N = {N}\n')
i = 2
while i < 1000:
    if N % i == 0:
        print(f'--> GCD Result is an integer multiple of N! Dividing N by i = {i}')
        N = N // i
        i = 1
    i += 1

# Solve Coppersmith
print('Solving Coppersmith...\n')
hidden = 512
tmp = isqrt(N/(1337*7331))
print(f'Recovered tmp = {tmp}\n')

q_approx = 7331*tmp - 2**hidden
F.<x> = PolynomialRing(Zmod(N), implementation='NTL')
f = x + q_approx
roots = f.small_roots(X=2**hidden, beta=0.1)

for delta in roots:
    q = q_approx + delta
    p = int(N) // int(q)
    phi = (p-1)*(q-1)
    d = pow(e, -1, phi)
    flag = long_to_bytes(int(pow(ciphertext, d, N))).decode()
    print(f'Recovered phi = {phi}\n')
    print(f'Recovered p = {p}\n')
    print(f'Recovered q = {q}\n')
    print(f'Recovered d = {d}\n')
    print(f'flag = {flag}')
